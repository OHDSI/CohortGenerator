<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Sampling Cohorts • CohortGenerator</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Sampling Cohorts">
<link rel="stylesheet" type="text/css" href="extra.css">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CohortGenerator</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.12.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/CreatingCohortSubsetDefinitions.html">Creating Cohort Subset Definitions</a></li>
    <li><a class="dropdown-item" href="../articles/GeneratingCohorts.html">Generating Cohorts</a></li>
    <li><a class="dropdown-item" href="../articles/SamplingCohorts.html">Sampling Cohorts</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://ohdsi.github.io/Hades" aria-label="hadesLogo">hadesLogo</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/OHDSI/CohortGenerator/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Sampling Cohorts</h1>
                        <h4 data-toc-skip class="author">James P.
Gilbert</h4>
            
            <h4 data-toc-skip class="date">2025-09-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/CohortGenerator/blob/v0.12.2/vignettes/SamplingCohorts.Rmd" class="external-link"><code>vignettes/SamplingCohorts.Rmd</code></a></small>
      <div class="d-none name"><code>SamplingCohorts.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="sampling-with-cohortgenerator">Sampling with CohortGenerator<a class="anchor" aria-label="anchor" href="#sampling-with-cohortgenerator"></a>
</h2>
<p>Large populations of individuals (e.g. all subjects receiving a
COVID-19 vaccination) can often be too large to work with when pulling
down a large collection of covariates for further analysis. This is
prohibitive when designing studies or attempting to generate phenotypes.
This guide aims to demonstrate how one can use the
<code>sampleCohortDefinitionSet</code> functionality to produce
sufficiently large sample cohorts from a base
<code>cohortDefinitionSet</code>.</p>
<div class="section level3">
<h3 id="sampling-method">Sampling method<a class="anchor" aria-label="anchor" href="#sampling-method"></a>
</h3>
<p>The approach taken in this method is to sample individuals within a
cohort without replacement. Different database platforms implement a
variety of different approaches for random sampling and random number
generation that make cross platform sql difficult. Consequently, all the
randomness computed here happens inside <code>R</code> itself simply
from the count of unique individuals within a cohort.</p>
</div>
<div class="section level3">
<h3 id="using-the-sampler-functions">Using the sampler functions<a class="anchor" aria-label="anchor" href="#using-the-sampler-functions"></a>
</h3>
<p>To create a single sample the approach below will create cohorts in
the same base table.</p>
<p>First we need to load the initial cohort definition set</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCohortDefinitionSet.html">getCohortDefinitionSet</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>We then need to create the cohort tables and cohorts in the usual
manner.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/getEunomiaConnectionDetails.html" class="external-link">getEunomiaConnectionDetails</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">conn</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span>connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/disconnect.html" class="external-link">disconnect</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">cds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCohortDefinitionSet.html">getCohortDefinitionSet</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="va">cohortTableNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCohortTableNames.html">getCohortTableNames</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="st">"cohort"</span><span class="op">)</span></span>
<span><span class="va">recordKeepingFolder</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">outputFolder</span>, <span class="st">"RecordKeepingSamples"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/createCohortTables.html">createCohortTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/generateCohortSet.html">generateCohortSet</a></span><span class="op">(</span></span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cds</span>,</span>
<span>  connection <span class="op">=</span> <span class="va">conn</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  incremental <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  incrementalFolder <span class="op">=</span> <span class="va">recordKeepingFolder</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can then create a new cohort definition set from the original
sample.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sampledCohortDefinitionSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sampleCohortDefinitionSet.html">sampleCohortDefinitionSet</a></span><span class="op">(</span></span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cds</span>,</span>
<span>  connection <span class="op">=</span> <span class="va">conn</span>,</span>
<span>  sampleFraction <span class="op">=</span> <span class="fl">0.33</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">64374</span>, <span class="co"># OHDSI</span></span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  incremental <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  incrementalFolder <span class="op">=</span> <span class="va">recordKeepingFolder</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The resulting <code>sampledCohortDefinitionSet</code> is nearly
identical to the base cohort set, however a few changes occur:</p>
<ul>
<li>The name now include the postfix
<code>[sample 33% seed=64374]</code>
</li>
<li>The optional parameter <code>idExpression</code> changes the cohort
name. By default this is set to <code>cohortId * 1000 + seed</code>
however, this will throw an error if the ids are the same</li>
<li>The</li>
<li>The base cohortDefinitionSet is attached as an attribute to the
<code>sampledCohortDefinitionSet</code>
</li>
</ul>
<p>To generate multiple samples, simply specify multiple seed variables
as follows:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate 800 samples of size n</span></span>
<span><span class="va">sampledCohortDefinitionSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sampleCohortDefinitionSet.html">sampleCohortDefinitionSet</a></span><span class="op">(</span></span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cds</span>,</span>
<span>  connection <span class="op">=</span> <span class="va">conn</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  seed <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">800</span> <span class="op">*</span> <span class="fl">64374</span>, <span class="co"># OHDSI</span></span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  incremental <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  incrementalFolder <span class="op">=</span> <span class="va">recordKeepingFolder</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that using incremental mode for your sampled cohorts will also
work. In this case, a cohort will only be re-generated if the checksum
of the base cohort has changed (the checksum is based on the cohort
SQL). The checksum applies to the pseudorandom seed of the cohort and
the sample size (n).</p>
<p>As the sampledCohortDefinitionSet is, for all intents and purposes, a
set of cohortDefinitions it can be passed as a parameter to all other
OHDSI packages with minimal issues. For example,
<code>FeatureExtraction</code> will be able to use this sample
unchanged.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">old</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Anthony Sena, Jamie Gilbert, Gowtham Rao, Freddy Avila Cruz, Martijn Schuemie.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
