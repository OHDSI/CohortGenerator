<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Generating Cohorts • CohortGenerator</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Generating Cohorts">
<link rel="stylesheet" type="text/css" href="extra.css">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CohortGenerator</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.12.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/CreatingCohortSubsetDefinitions.html">Creating Cohort Subset Definitions</a></li>
    <li><a class="dropdown-item" href="../articles/GeneratingCohorts.html">Generating Cohorts</a></li>
    <li><a class="dropdown-item" href="../articles/SamplingCohorts.html">Sampling Cohorts</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://ohdsi.github.io/Hades" aria-label="hadesLogo">hadesLogo</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/OHDSI/CohortGenerator/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Generating Cohorts</h1>
                        <h4 data-toc-skip class="author">Anthony G. Sena
and Martijn J. Schuemie</h4>
            
            <h4 data-toc-skip class="date">2025-07-31</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/CohortGenerator/blob/main/vignettes/GeneratingCohorts.Rmd" class="external-link"><code>vignettes/GeneratingCohorts.Rmd</code></a></small>
      <div class="d-none name"><code>GeneratingCohorts.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="guide-for-generating-cohorts-using-cohortgenerator">Guide for generating cohorts using CohortGenerator<a class="anchor" aria-label="anchor" href="#guide-for-generating-cohorts-using-cohortgenerator"></a>
</h2>
<p>This guide will provide examples of using the CohortGenerator package
to generate <a href="https://ohdsi.github.io/TheBookOfOhdsi/Cohorts.html" class="external-link">cohorts</a>
in R. In this vignette, we will walk through the process of building a
cohort definition set cohorts and look at the options available for
generating the cohorts.</p>
<div class="section level3">
<h3 id="basic-example">Basic Example<a class="anchor" aria-label="anchor" href="#basic-example"></a>
</h3>
<div class="section level4">
<h4 id="loading-a-cohort-definition-set-from-atlas">Loading a cohort definition set from ATLAS<a class="anchor" aria-label="anchor" href="#loading-a-cohort-definition-set-from-atlas"></a>
</h4>
<p>We can create cohorts using <a href="https://github.com/OHDSI/Atlas" class="external-link">ATLAS</a> and download them for
generation in R using the <a href="https://ohdsi.github.io/ROhdsiWebApi/reference/exportCohortDefinitionSet.html" class="external-link">exportCohortDefinitionSet</a>
function of the <code>ROhdsiWebApi</code> package.</p>
</div>
<div class="section level4">
<h4 id="loading-an-example-cohort-definition-set">Loading an example cohort definition set<a class="anchor" aria-label="anchor" href="#loading-an-example-cohort-definition-set"></a>
</h4>
<p>Here we will load a cohort definition set using some cohorts we use
to test the <code>CohortGenerator</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohortDefinitionSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCohortDefinitionSet.html">getCohortDefinitionSet</a></span><span class="op">(</span></span>
<span>  settingsFileName <span class="op">=</span> <span class="st">"testdata/name/Cohorts.csv"</span>,</span>
<span>  jsonFolder <span class="op">=</span> <span class="st">"testdata/name/cohorts"</span>,</span>
<span>  sqlFolder <span class="op">=</span> <span class="st">"testdata/name/sql/sql_server"</span>,</span>
<span>  cohortFileNameFormat <span class="op">=</span> <span class="st">"%s"</span>,</span>
<span>  cohortFileNameValue <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cohortName"</span><span class="op">)</span>,</span>
<span>  packageName <span class="op">=</span> <span class="st">"CohortGenerator"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohortIds</span> <span class="op">&lt;-</span> <span class="va">cohortDefinitionSet</span><span class="op">$</span><span class="va">cohortId</span></span>
<span><span class="va">cohortDefinitionSet</span><span class="op">$</span><span class="va">atlasId</span> <span class="op">&lt;-</span> <span class="va">cohortDefinitionSet</span><span class="op">$</span><span class="va">cohortId</span></span>
<span><span class="va">cohortDefinitionSet</span><span class="op">$</span><span class="va">logicDescription</span> <span class="op">&lt;-</span> <span class="st">""</span></span></code></pre></div>
<p>The code above constructs a <code>cohortDefinitionSet</code>
data.frame using a set of cohorts that come with the CohortGenerator
package. The <code>cohortDefinitionSet</code> data frame has the
following columns:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cohortDefinitionSet</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] "cohortId"         "cohortName"       "json"             "sql"             </span></span>
<span><span class="co">#&gt; [5] "atlasId"          "logicDescription"</span></span></code></pre>
<p>Here is how these columns are used:</p>
<ul>
<li>
<strong>atlasId</strong>: The ATLAS ID for the cohort. This provides
linkage back to the ATLAS cohort definition</li>
<li>
<strong>cohortId</strong>: The cohortId will be the same as the
atlasId upon export from ATLAS. We provide this column in case you’d
like to alter the numbering scheme for your cohort definition set.</li>
<li>
<strong>cohortName</strong>: The name of the cohort in ATLAS.</li>
<li>
<strong>sql</strong>: The SQL used to construct the cohort.</li>
<li>
<strong>json</strong>: The <a href="https://github.com/OHDSI/circe-be" class="external-link">Circe</a> compliant JSON
representation of the cohort definition. The <a href="https://ohdsi.github.io/CirceR/index.html" class="external-link">CirceR</a> package is
used to create the SQL from the Circe json.</li>
<li>
<strong>logicDescription</strong>: The description of the cohort
from ATLAS.</li>
</ul>
</div>
<div class="section level4">
<h4 id="saving-in-a-study-package">Saving in a study package<a class="anchor" aria-label="anchor" href="#saving-in-a-study-package"></a>
</h4>
<p>The <code>cohortDefinitionSet</code> contains all of the details
about each cohort that we would like to use for generation. As a best
practice, we recommend that you embed these cohort details into a study
package. To do this, we’ve created a function to save the cohort
definition set to the file system:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/saveCohortDefinitionSet.html">saveCohortDefinitionSet</a></span><span class="op">(</span></span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cohortDefinitionSet</span>,</span>
<span>  settingsFileName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">packageRoot</span>,</span>
<span>    <span class="st">"inst/settings/CohortsToCreate.csv"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  jsonFolder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">packageRoot</span>,</span>
<span>    <span class="st">"inst/cohorts"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  sqlFolder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">packageRoot</span>,</span>
<span>    <span class="st">"inst/sql/sql_server"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>By default, saving the cohort definition set will create the files
under a folder called <code>inst</code> which is where resources for a
study package will live. Under <code>inst</code> the following folders
and files are created:</p>
<ul>
<li>
<strong>inst/settings/CohortsToCreate.csv</strong>: This will hold
the list of cohorts found in the cohortDefinitionSet.</li>
<li>
<strong>inst/cohorts</strong>: This folder will contain a .json file
per cohort definition.</li>
<li>
<strong>inst/sql/sql_server</strong>: This folder will contain a
.sql file per cohort definition.</li>
</ul>
<p>Your study package can later re-construct the cohortDefinitionSet by
reading in these resources using the <code>getCohortDefinitionSet</code>
function.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohortDefinitionSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCohortDefinitionSet.html">getCohortDefinitionSet</a></span><span class="op">(</span></span>
<span>  settingsFileName <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="va">packageRoot</span>, <span class="st">"inst/settings/CohortsToCreate.csv"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  jsonFolder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">packageRoot</span>, <span class="st">"inst/cohorts"</span><span class="op">)</span>,</span>
<span>  sqlFolder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">packageRoot</span>, <span class="st">"inst/sql/sql_server"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="generating-cohorts">Generating Cohorts<a class="anchor" aria-label="anchor" href="#generating-cohorts"></a>
</h4>
<p>Now that we have created the <code>cohortDefinitionSet</code>, we’re
ready to generate our cohorts against our OMOP CDM. In this example, we
will use the <a href="https://github.com/OHDSI/Eunomia" class="external-link">Eunomia</a> data
set as our CDM.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get the Eunomia connection details</span></span>
<span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">Eunomia</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/getEunomiaConnectionDetails.html" class="external-link">getEunomiaConnectionDetails</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># First get the cohort table names to use for this generation task</span></span>
<span><span class="va">cohortTableNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCohortTableNames.html">getCohortTableNames</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="st">"cg_example"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Next create the tables on the database</span></span>
<span><span class="fu"><a href="../reference/createCohortTables.html">createCohortTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate the cohort set</span></span>
<span><span class="va">cohortsGenerated</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet.html">generateCohortSet</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cohortDefinitionSet</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The code above starts by obtaining the <code>connectionDetails</code>
from Eunomia. This is where you’ll likely want to substitute your own
connection information. Next, we call <code>getCohortTableNames</code>
to obtain a list of <code>cohortTableNames</code> that we’ll use for the
generation process. We then call <code>createCohortTables</code> to
create the cohort tables on the database server in the
<code>cohortDatabaseSchema</code>. Once these tables are created, we use
the function <code>generateCohortSet</code> to generate the
<code>cohortDefinitionSet</code>. When calling
<code>generateCohortSet</code>, we must specify the schema that holds
our CDM (<code>cdmDatabaseSchema</code>), the location of the
<code>cohortDatabaseSchema</code> and <code>cohortTableNames</code>
where the cohort(s) will be generated. We will cover the other
parameters available in the <a href="#advancedOptions">Advanced
Options</a> section.</p>
<p>If we’d like to see the results of the generation process, we can use
the <code>getCohortCounts</code> method to query the cohort table for a
summary of the persons and events for each cohort:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/getCohortCounts.html">getCohortCounts</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTable <span class="op">=</span> <span class="va">cohortTableNames</span><span class="op">$</span><span class="va">cohortTable</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Connecting using SQLite driver</span></span>
<span><span class="co">#&gt; Counting cohorts took 0.057 secs</span></span></code></pre>
<pre><code><span><span class="co">#&gt;   cohortId cohortEntries cohortSubjects</span></span>
<span><span class="co">#&gt; 1        1          1800           1800</span></span>
<span><span class="co">#&gt; 2        2           569            569</span></span>
<span><span class="co">#&gt; 3        3           266            266</span></span>
<span><span class="co">#&gt; 4        4          1750           1750</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="advancedOptions">Advanced Options<a class="anchor" aria-label="anchor" href="#advancedOptions"></a>
</h3>
<div class="section level4">
<h4 id="cohort-statistics-inclusion-rule-statistics">Cohort Statistics (Inclusion Rule Statistics)<a class="anchor" aria-label="anchor" href="#cohort-statistics-inclusion-rule-statistics"></a>
</h4>
<p>Cohorts defined in ATLAS may define one or more inclusion criteria as
part of the cohort’s logic. As part of cohort generation, we may want to
capture these cohort statistics for use in other packages. For example,
<a href="https://ohdsi.github.io/CohortDiagnostics" class="external-link">CohortDiagnostics</a>
has functionality that allows for review of inclusion rule statistics to
understand how these rules may materialize between data sources.</p>
<p>Here we will review how to generate cohorts with inclusion rule
statistics and how to export these results for use by downstream
packages such as CohortDiagnostics. If you have constructed your cohorts
in ATLAS, you can again use the <a href="https://ohdsi.github.io/ROhdsiWebApi/reference/exportCohortDefinitionSet.html" class="external-link">exportCohortDefinitionSet</a>
function of the <code>ROhdsiWebApi</code> package. The <a href="https://ohdsi.github.io/ROhdsiWebApi/reference/exportCohortDefinitionSet.html" class="external-link">exportCohortDefinitionSet</a>
function has an additional parameter called <code>generateStats</code>
which when set to TRUE will include the SQL necessary to generate the
cohort statistics.</p>
<p>Building on our previous example where we loaded a cohort set from
the <code>CohortGenerator</code> package, let’s include the code that
will build the SQL for the cohort statistics:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First construct a cohort definition set: an empty</span></span>
<span><span class="co"># data frame with the cohorts to generate</span></span>
<span><span class="va">cohortDefinitionSet</span> <span class="op">&lt;-</span> <span class="fu">CohortGenerator</span><span class="fu">::</span><span class="fu"><a href="../reference/createEmptyCohortDefinitionSet.html">createEmptyCohortDefinitionSet</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fill the cohort set using  cohorts included in this</span></span>
<span><span class="co"># package as an example</span></span>
<span><span class="va">cohortJsonFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"testdata/name/cohorts"</span>, package <span class="op">=</span> <span class="st">"CohortGenerator"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cohortJsonFiles</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cohortJsonFileName</span> <span class="op">&lt;-</span> <span class="va">cohortJsonFiles</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">cohortName</span> <span class="op">&lt;-</span> <span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/fileutils.html" class="external-link">file_path_sans_ext</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">cohortJsonFileName</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># Here we read in the JSON in order to create the SQL</span></span>
<span>  <span class="co"># using [CirceR](https://ohdsi.github.io/CirceR/)</span></span>
<span>  <span class="co"># If you have your JSON and SQL stored differently, you can</span></span>
<span>  <span class="co"># modify this to read your JSON/SQL files however you require</span></span>
<span>  <span class="va">cohortJson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readChar.html" class="external-link">readChar</a></span><span class="op">(</span><span class="va">cohortJsonFileName</span>, <span class="fu"><a href="https://rdrr.io/r/base/file.info.html" class="external-link">file.info</a></span><span class="op">(</span><span class="va">cohortJsonFileName</span><span class="op">)</span><span class="op">$</span><span class="va">size</span><span class="op">)</span></span>
<span>  <span class="va">cohortExpression</span> <span class="op">&lt;-</span> <span class="fu">CirceR</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CirceR/reference/cohortExpressionFromJson.html" class="external-link">cohortExpressionFromJson</a></span><span class="op">(</span><span class="va">cohortJson</span><span class="op">)</span></span>
<span>  <span class="va">cohortSql</span> <span class="op">&lt;-</span> <span class="fu">CirceR</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CirceR/reference/buildCohortQuery.html" class="external-link">buildCohortQuery</a></span><span class="op">(</span><span class="va">cohortExpression</span>, options <span class="op">=</span> <span class="fu">CirceR</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/CirceR/reference/createGenerateOptions.html" class="external-link">createGenerateOptions</a></span><span class="op">(</span>generateStats <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">cohortDefinitionSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">cohortDefinitionSet</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    cohortId <span class="op">=</span> <span class="va">i</span>,</span>
<span>    cohortName <span class="op">=</span> <span class="va">cohortName</span>,</span>
<span>    json <span class="op">=</span> <span class="va">cohortJson</span>,</span>
<span>    sql <span class="op">=</span> <span class="va">cohortSql</span>,</span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In the code above, we read in the cohort JSON files from the package
and then use <a href="https://ohdsi.github.io/CirceR/index.html" class="external-link">CirceR</a> to build the
cohort query SQL using the <code><a href="https://ohdsi.github.io/CirceR/reference/buildCohortQuery.html" class="external-link">CirceR::buildCohortQuery</a></code>
command. Note that in this function we are specifying the
<code>options = CirceR::createGenerateOptions(generateStats = TRUE)</code>
to indicate that the SQL should include the code necessary to compute
the cohort statistics.</p>
<p>Next we’ll create the tables to store the cohort and the cohort
statistics. Then we can generate the cohorts.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First get the cohort table names to use for this generation task</span></span>
<span><span class="va">cohortTableNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCohortTableNames.html">getCohortTableNames</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="st">"stats_example"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Next create the tables on the database</span></span>
<span><span class="fu"><a href="../reference/createCohortTables.html">createCohortTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We can then generate the cohorts the same way as before and it will use the</span></span>
<span><span class="co"># cohort statstics tables to store the results</span></span>
<span><span class="co"># Generate the cohort set</span></span>
<span><span class="fu"><a href="../reference/generateCohortSet.html">generateCohortSet</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cohortDefinitionSet</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>At this stage, your cohorts are generated and any cohort statistics
are available in the cohort statistics tables. The next step is to
export the results to the file system which is done using the code
below:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/insertInclusionRuleNames.html">insertInclusionRuleNames</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cohortDefinitionSet</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortInclusionTable <span class="op">=</span> <span class="va">cohortTableNames</span><span class="op">$</span><span class="va">cohortInclusionTable</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/exportCohortStatsTables.html">exportCohortStatsTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortStatisticsFolder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">someFolder</span>, <span class="st">"InclusionStats"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The code above performs two steps. First, we insert the inclusion
rule names from the Circe expressions in the
<code>cohortDefinitionSet</code>. This is important since these names
are not automatically inserted into the database when generating the
cohorts. Second, we export the cohort statistics to the file system
which will write comma separated value (CSV) files per cohort statistic
table in the <code>InclusionStats</code> folder.</p>
<p>Once you have exported your cohort statistics, you can optionally
drop the statistics tables by using the following command:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dropCohortStatsTables.html">dropCohortStatsTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="incremental-mode">Incremental Mode<a class="anchor" aria-label="anchor" href="#incremental-mode"></a>
</h4>
<p>CohortGenerator provides an <code>incremental</code> option for some
of its functions. The purpose of this <code>incremental</code> setting
is to allow for the code to attempt to skip an operation if it has
already completed it. For example, in the context of cohort generation
we may want to keep track of cohorts that we have already generated
against a source and skip it if we know the cohort definition has not
changed. To illustrate incremental mode and explain how it works, we’ll
continue along with our example from earlier.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a set of tables for this example</span></span>
<span><span class="va">cohortTableNames</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getCohortTableNames.html">getCohortTableNames</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="st">"cohort"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/createCohortTables.html">createCohortTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  incremental <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As expected, the code created the cohort tables as requested. Under
the hood, since <code>incremental = TRUE</code> was set, the code did a
check against the database to see if the tables already exist before
creating them. To verify this, we can call the function again and check
the results:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/createCohortTables.html">createCohortTables</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  incremental <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Connecting using SQLite driver</span></span>
<span><span class="co">#&gt; Table "cohort" already exists and in incremental mode, so not recreating it.</span></span>
<span><span class="co">#&gt; Table "cohort" already exists and in incremental mode, so not recreating it.</span></span>
<span><span class="co">#&gt; Table "cohort_inclusion" already exists and in incremental mode, so not recreating it.</span></span>
<span><span class="co">#&gt; Table "cohort_inclusion_result" already exists and in incremental mode, so not recreating it.</span></span>
<span><span class="co">#&gt; Table "cohort_inclusion_stats" already exists and in incremental mode, so not recreating it.</span></span>
<span><span class="co">#&gt; Table "cohort_summary_stats" already exists and in incremental mode, so not recreating it.</span></span>
<span><span class="co">#&gt; Table "cohort_censor_stats" already exists and in incremental mode, so not recreating it.</span></span></code></pre>
<p>The use of <code>incremental = TRUE</code> here allows for assurance
that tables and results from previous runs are preserved. Next, we can
generate our <code>cohortDefinitionSet</code> in incremental mode.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/generateCohortSet.html">generateCohortSet</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cohortDefinitionSet</span>,</span>
<span>  incremental <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  incrementalFolder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">someFolder</span>, <span class="st">"RecordKeeping"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here we indicate that we are performing this operational
incrementally by specifying <code>incremental = TRUE</code> and by
specifying a folder for holding a record keeping file to track where
cohorts are generated:
<code>incrementalFolder = file.path(someFolder, "RecordKeeping")</code>.
Once a cohort is generated in incremental mode, the cohort ID and a
checksum of the cohort SQL are saved in the
<code>incrementalFolder</code> in a file called
<code>GeneratedCohorts.csv</code>. If we attempt to re-generate the same
cohort set in incremental mode, <code>generateCohortSet</code> will
inspect the SQL for each cohort in the <code>cohortDefinitionSet</code>
and if the checksum of that cohort matches the checksum found in the
<code>incrementalFolder</code> for the same cohort ID, the generation is
skipped. To illustrate how this looks:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/generateCohortSet.html">generateCohortSet</a></span><span class="op">(</span></span>
<span>  connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>  cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>  cohortTableNames <span class="op">=</span> <span class="va">cohortTableNames</span>,</span>
<span>  cohortDefinitionSet <span class="op">=</span> <span class="va">cohortDefinitionSet</span>,</span>
<span>  incremental <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  incrementalFolder <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">someFolder</span>, <span class="st">"RecordKeeping"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; Connecting using SQLite driver</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Initiating cluster consisting only of main thread</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Skipping cohortId = '1' because it is unchanged from earlier run</span></span>
<span><span class="co">#&gt; Skipping cohortId = '2' because it is unchanged from earlier run</span></span>
<span><span class="co">#&gt; Skipping cohortId = '3' because it is unchanged from earlier run</span></span>
<span><span class="co">#&gt; Skipping cohortId = '4' because it is unchanged from earlier run</span></span></code></pre>
<pre><code><span><span class="co">#&gt; Generating cohort set took 0.03 secs</span></span></code></pre>
<div class="section level5">
<h5 id="potential-pitfalls-of-incremental-mode">Potential Pitfalls of Incremental Mode<a class="anchor" aria-label="anchor" href="#potential-pitfalls-of-incremental-mode"></a>
</h5>
<p>Incremental mode makes some assumptions to provide a more flexible
way to generate cohorts. These assumptions come with some risks that we
would like to highlight:</p>
<ul>
<li>
<strong>Record keeping files</strong>: The incremental approach for
cohort generation makes use of a record keeping file to check if a
cohort has already been generated. It does <strong>not</strong> check
the database to verify this so you need to take care and preserve the
file system where you store the record keeping file. If the file is
removed, CohortGenerator will simply repeat the cohort generation
process.</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span><span class="va">old</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Anthony Sena, Jamie Gilbert, Gowtham Rao, Freddy Avila Cruz, Martijn Schuemie.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
